<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiniela de Fútbol</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            text-align: center;
            margin: 20px;
        }
        .container {
            max-width: 600px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid transparent; /* Borde transparente */
            padding: 5px 10px;
            text-align: center;
            white-space: nowrap;
        }
        th {
            background-color: #FF4D4D;
            color: white;
        }
        th:first-child, td:first-child {
            width: 10%; /* La columna "#" más estrecha */
        }
        th:nth-child(2), td:nth-child(2) {
            width: 50%; /* La columna "Partido" más ancha */
        }
        th:nth-child(n+3), td:nth-child(n+3) {
            width: 13%; /* Las columnas 1, X, 2 equilibradas */
        }

        /* Estilos para las filas con color */
        .rojo-claro {
            background-color: #ffcccc; /* Rojo muy claro */
        }
        .blanco {
            background-color: white;
        }

        /* Estilo para los checkboxes */
        input[type="checkbox"] {
            display: none; /* Ocultamos el checkbox real */
        }

        /* Etiqueta para hacer estilo personalizado en los checkboxes */
        label {
            display: inline-block;
            width: 25%; /* Ancho del 25% para que se distribuyan horizontalmente */
            padding: 10px;
            font-size: 16px;
            background-color: #fff;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
        }

        /* Estilo cuando el checkbox está marcado */
        input[type="checkbox"]:checked + label {
            background-color: #ff4d4d; /* Fondo rojo */
            color: white;
            border-color: #ff4d4d; /* Borde rojo */
        }

        /* Contenedor para las casillas P15 */
        .p15-container {
            display: flex;
            justify-content: space-between;
            gap: 5px; /* Espaciado entre las casillas */
            width: 100%;
        }
    </style>
    <!-- Usamos la nueva URL para EmailJS SDK -->
    <script type="module">
        import { init, send } from "https://cdn.emailjs.com/dist/email.min.js";
        init('jR5XUuwzJdrjI_FVp');  // Inicializar EmailJS con tu clave pública
    </script>
</head>
<body>
    <div class="container">
        <h2>Vota en la Quiniela</h2>
        <form id="quinielaForm">
            <table id="quinielaTable">
                <tr>
                    <th colspan="5" id="headerJornada">Jornada fin de semana</th>
                </tr>
                <tr>
                    <th>#</th>
                    <th>Partido</th>
                    <th>1</th>
                    <th>X</th>
                    <th>2</th>
                </tr>
            </table>
            <br>
            <button type="button" class="btn" onclick="enviarQuiniela()">Enviar Quiniela</button>
        </form>
    </div>

    <script>
        let triples = 0;
        let dobles = 0;
        const maxTriples = 2;
        const maxDobles = 4;
        let data = null;  // Variable global donde guardaremos los datos de los partidos

        function actualizarContadores() {
            triples = 0;
            dobles = 0;
            for (let i = 1; i <= 14; i++) {
                let seleccionadas = document.querySelectorAll(`input[name='partido${i}']:checked`).length;
                if (seleccionadas === 3) {
                    triples++;
                } else if (seleccionadas === 2) {
                    dobles++;
                }
            }
        }

        function validarSeleccion(event, partido) {
            actualizarContadores();
            if (triples > maxTriples || dobles > maxDobles) {
                event.target.checked = false;
                actualizarContadores();
                alert("Has superado el límite de triples o dobles permitidos.");
            }
        }

        // Función para asegurarse de que solo se pueda marcar una casilla en P15
        function marcarSoloUno(event, partido) {
            const checkboxesArr = document.querySelectorAll(`input[name='${partido}']`);
            checkboxesArr.forEach((checkbox) => {
                if (checkbox !== event.target) {
                    checkbox.checked = false;
                }
            });
        }

        async function cargarDatos() {
            try {
                let response = await fetch("https://raw.githubusercontent.com/loteriaslafortuna/quiniela/main/partidos.json");
                let result = await response.json();
                data = result;  // Asignamos los datos a la variable global `data`
                generarTabla(result);
            } catch (error) {
                console.error("Error al cargar el archivo JSON:", error);
            }
        }

        function generarTabla(data) {
            let tabla = document.getElementById("quinielaTable");
            let headerJornada = document.getElementById("headerJornada");
            headerJornada.innerHTML = data.jornada;

            // Crear las filas de los partidos
            data.partidos.slice(0, 14).forEach((partido, index) => {
                let row = document.createElement("tr");

                if ((index >= 0 && index <= 3) || (index >= 8 && index <= 10) || index === 14) {
                    row.classList.add('rojo-claro');
                } else {
                    row.classList.add('blanco');
                }

                row.innerHTML = 
                    `<td>${index + 1}</td>
                    <td>${partido.equipo1} vs ${partido.equipo2}</td>
                    <td><input type="checkbox" id="partido${index + 1}1" name="partido${index + 1}" value="1" onclick="validarSeleccion(event, ${index + 1})"><label for="partido${index + 1}1">1</label></td>
                    <td><input type="checkbox" id="partido${index + 1}X" name="partido${index + 1}" value="X" onclick="validarSeleccion(event, ${index + 1})"><label for="partido${index + 1}X">X</label></td>
                    <td><input type="checkbox" id="partido${index + 1}2" name="partido${index + 1}" value="2" onclick="validarSeleccion(event, ${index + 1})"><label for="partido${index + 1}2">2</label></td>`;
                tabla.appendChild(row);
            });

            let rowPleno = document.createElement("tr");
            rowPleno.classList.add('rojo-claro');
            rowPleno.innerHTML = 
                `<td rowspan="2">P15</td>
                <td>${data.partidos[14].equipo1}</td>
                <td colspan="3"><div class="p15-container">
                        <input type="checkbox" id="pleno1_0" name="pleno1" value="0" onclick="marcarSoloUno(event, 'pleno1')"><label for="pleno1_0">0</label>
                        <input type="checkbox" id="pleno1_1" name="pleno1" value="1" onclick="marcarSoloUno(event, 'pleno1')"><label for="pleno1_1">1</label>
                        <input type="checkbox" id="pleno1_2" name="pleno1" value="2" onclick="marcarSoloUno(event, 'pleno1')"><label for="pleno1_2">2</label>
                        <input type="checkbox" id="pleno1_M" name="pleno1" value="M" onclick="marcarSoloUno(event, 'pleno1')"><label for="pleno1_M">M</label>
                    </div></td>`;
            tabla.appendChild(rowPleno);

            let rowPleno2 = document.createElement("tr");
            rowPleno2.classList.add('rojo-claro');
            rowPleno2.innerHTML = 
                `<td>${data.partidos[14].equipo2}</td>
                <td colspan="3"><div class="p15-container">
                        <input type="checkbox" id="pleno2_0" name="pleno2" value="0" onclick="marcarSoloUno(event, 'pleno2')"><label for="pleno2_0">0</label>
                        <input type="checkbox" id="pleno2_1" name="pleno2" value="1" onclick="marcarSoloUno(event, 'pleno2')"><label for="pleno2_1">1</label>
                        <input type="checkbox" id="pleno2_2" name="pleno2" value="2" onclick="marcarSoloUno(event, 'pleno2')"><label for="pleno2_2">2</label>
                        <input type="checkbox" id="pleno2_M" name="pleno2" value="M" onclick="marcarSoloUno(event, 'pleno2')"><label for="pleno2_M">M</label>
                    </div></td>`;
            tabla.appendChild(rowPleno2);
        }

        function enviarQuiniela() {
            console.log("Enviando quiniela...");

            // Actualizar contadores
            actualizarContadores();

            let seleccionesSimples = 0;
            for (let i = 1; i <= 14; i++) {
                let seleccionadas = document.querySelectorAll(`input[name='partido${i}']:checked`).length;
                if (seleccionadas === 1) {
                    seleccionesSimples++;
                }
            }

            let pleno1 = document.querySelector("input[name='pleno1']:checked");
            let pleno2 = document.querySelector("input[name='pleno2']:checked");

            if (triples !== maxTriples || dobles !== maxDobles || seleccionesSimples !== 8 || !pleno1 || !pleno2) {
                alert("Debes seleccionar exactamente 2 triples, 4 dobles, 8 selecciones simples y una opción en cada equipo del Pleno al 15.");
                return;
            }

            // Preparar los datos para el envío
            let formData = {
                jornada: document.getElementById("headerJornada").innerText,
                quiniela: JSON.stringify(data.partidos.slice(0, 14)),  // Solo los partidos, no todo el JSON
                pleno1: pleno1.value,
                pleno2: pleno2.value,
            };

            // Enviar el correo con EmailJS usando el Service ID y Template ID
            send("service_z9ljfph", "template_g6f7tdv", formData)
                .then(function(response) {
                    console.log("Correo enviado:", response);
                    alert("¡Quiniela enviada correctamente!");
                }, function(error) {
                    console.error("Error al enviar el correo:", error);
                    alert("Error al enviar la quiniela: " + error.text);
                });
        }

        window.onload = cargarDatos;
    </script>
</body>
</html>
